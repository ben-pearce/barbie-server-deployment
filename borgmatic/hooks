#!/bin/bash

ability () {
    host=$1
    shift 1
    ssh "$host" -qt ability "$@"
}

mount () {
    host=$1
    sshfs \
        borg@"$host":/ \
        "$(mount-point "$host")" \
        -o StrictHostKeyChecking=no \
        -o sftp_server="/usr/local/bin/ability mount-filesystem"
}

unmount () {
    host=$1
    umount -l "$(mount-point "$host")"
}

mount-point () {
    host=$1
    echo /etc/borgmatic.d/"$host"
}

check-empty () {
    dir=$1
    if [ -n "$(ls -A "$dir" 2>/dev/null)" ]; then
        exit 75
    else
        exit 0
    fi
}

exclude-gitignore-files () {
    dir=$1
    out=$2
    find "$dir" -type f -name ".gitignore" | while read -r gitignore_file; do
        base_dir=$(dirname "$gitignore_file")
        grep -vE '^\s*#|^\s*$' "$gitignore_file" | while read -r line; do
            echo "$base_dir/$line" >> "$out"
        done
    done
}

"$1" "${@:2}"
